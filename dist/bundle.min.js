Array.prototype.max=function(){return Math.max.apply(null,this)};Array.prototype.min=function(){return Math.min.apply(null,this)};Array.prototype.maxIndex=function(){return this.indexOf(Math.max.apply(null,this))};Array.prototype.minIndex=function(){return this.indexOf(Math.min.apply(null,this))};$.moveBottom=function(speed){$("html, body").animate({scrollTop:$(document).height()},speed??1e3)};let coefficientsForUP={freeCoefficient:2.834,hemoglobin:-.017,male:0,female:-1.295,hematohesia:-4.554,anamnesisGastrointestinalUpperBleeding:4.24,anamnesisGastrointestinalUndefinedBleeding:-18.167,melena:-1.279,coffeeVomit:3.777,bloodVomit:2.458};let coefficientsForMIDDLE={freeCoefficient:3.717,hemoglobin:-.017,male:0,female:-1.3,hematohesia:-3.81,anamnesisGastrointestinalUpperBleeding:2.197,anamnesisGastrointestinalUndefinedBleeding:3.918,melena:-2.56,coffeeVomit:-18.471,bloodVomit:-1.265};let hardness={1:"легкой",2:"средней",3:"тяжёлой"};let localizationDefinition={1:"верхних",2:"средних",3:"нижних"};let reasonsList={1:"варикозное расширение вен ЖКТ",2:"дивертикулы ЖКТ",3:"эрозивно-язвенные поражения тонкой/толстой кишки",4:"эрозивно-язвенные поражения верхних отделов ЖКТ",5:"сосудистые мальформации ЖКТ",6:"целиакия",7:"опухолевые заболевания ЖКТ"};function solveFor(coefficients,signs){return Math.exp(-(coefficients.freeCoefficient+coefficients.hemoglobin*signs.hemoglobin+(signs.gender==="female"?coefficients.female:coefficients.male)+(signs.hematohesia?coefficients.hematohesia:0)+(signs.anamnesisGastrointestinalUpperBleeding?coefficients.anamnesisGastrointestinalUpperBleeding:0)+(signs.anamnesisGastrointestinalUndefinedBleeding?coefficients.anamnesisGastrointestinalUndefinedBleeding:0)+(signs.melena?coefficients.melena:0)+(signs.coffeeVomit?coefficients.coffeeVomit:0)+(signs.bloodVomit?coefficients.bloodVomit:0)))}function localizationResolver(signs){let upProbability=solveFor(coefficientsForUP,signs);let middleProbability=solveFor(coefficientsForMIDDLE,signs);upProbability=1/(1+upProbability);middleProbability=1/(1+middleProbability);let downProbability=1-(upProbability+middleProbability);const localizations=[1,2,3];return{upProbability:upProbability,middleProbability:middleProbability,downProbability:downProbability,result:localizations[[upProbability,middleProbability,downProbability].maxIndex()]}}function bleedReasonResolver(signs){console.log(this);if(signs.v34||signs.v35){return 1}else if(signs.v25||signs.v27){return 2}else if(signs.v21||signs.v23||signs.v25||signs.v30||signs.v31||signs.v32||signs.v33){return 3}else if(signs.v21||signs.v23||signs.v24||signs.v28||signs.v32||signs.v33){return 4}else if(signs.v28||signs.v29||signs.v34){return 5}else if(signs.v22||signs.v31){return 6}else{return 7}}function conclusionBuilder(conclusion){return{explicit:conclusion===undefined?null:conclusion.explicit,bloodLossHardness:conclusion===undefined?0:conclusion.bloodLossHardness,DRICNecessity:conclusion===undefined?0:conclusion.DRICNecessity,localization:conclusion===undefined?0:conclusion.localization,reason:conclusion===undefined?0:conclusion.reason,andExplicit(indexes){console.log("Определяю явность");if(indexes.bloodVomit||indexes.coffeeVomit||indexes.melena||indexes.hematohesia){console.log("EXPLICIT");this.explicit=true}if(indexes.collaptoidState&&indexes.gastrointestinalUcler&&indexes.stickySweat||indexes.paleSkin&&indexes.gastrointestinalUcler&&indexes.hemoglobinFalls||indexes.hiddenBleeding){console.log("NOT EXPLICIT");this.explicit=false}return this},andBloodLossHardnessLevel(bloodSigns){console.log("Определяю тяжесть кровопотери по данным: ",bloodSigns);if((bloodSigns.erythrocytes>3.5)+(bloodSigns.pulse<=80)+(bloodSigns.bloodArterialPressure>110)+(bloodSigns.hematocrit>30)>=2&&bloodSigns.hemoglobin>100){this.bloodLossHardness=1}else if((bloodSigns.erythrocytes>=2.5&&bloodSigns.erythrocytes<=3.5)+(bloodSigns.pulse>=80&&bloodSigns.pulse<=100)+(bloodSigns.bloodArterialPressure>=90&&bloodSigns.bloodArterialPressure<=110)+(bloodSigns.hematocrit>=25&&bloodSigns.hematocrit<=30)>=2&&(bloodSigns.hemoglobin>=83&&bloodSigns.hemoglobin<=100)){this.bloodLossHardness=2}else if((bloodSigns.erythrocytes<2.5)+(bloodSigns.pulse>100)+(bloodSigns.bloodArterialPressure<90)+(bloodSigns.hematocrit<25)>=2&&bloodSigns.hemoglobin<83){this.bloodLossHardness=3}return this},andDRICNecessity(signs){if((signs.age>60)+(signs.pulse>100)+(signs.bloodArterialPressure<100)+(signs.hemoglobin<100)+signs.coffeeVomit+signs.melena+signs.lossConsciousness+signs.additionalIllness>=4){this.DRICNecessity=3}return this},predictLocalization(signs){this.localization=localizationResolver(signs).result;return this},setLocalization(localization){this.localization=localization;return this},andResolveReason(signs){console.log("Определяю причины",signs);this.reason=bleedReasonResolver.call(this,signs);return this},getConclusion(){let that=this;return{explicit:that.explicit,bloodLossHardness:that.bloodLossHardness,DRICNecessity:that.DRICNecessity,localizationPredict:that.localization,reason:that.reason}},getTag(){return $(`<div class="alert alert-info my-2" role="alert">ЖКК <b>${this.explicit?"явное":"скрытое"}</b></div>`).append((()=>this.localization?`, локализованное в <b>${localizationDefinition[this.localization]}</b> отделах ЖКТ`:".")).append((()=>{if(this.bloodLossHardness===1||this.bloodLossHardness===2){return this.bloodLossHardness?`, <b>${hardness[this.bloodLossHardness]}</b> степени тяжести`:"."}else if(this.bloodLossHardness===3){return this.bloodLossHardness?`, <b>${hardness[this.bloodLossHardness]}</b> степени`:"."}}))}}}if(typeof exports==="object"){module.exports={bleedReasonResolver:bleedReasonResolver,localizationResolver:localizationResolver}}(()=>{"use strict";function checkDecimalValidity(field,event){if(!/^\d+([,.]+\d+)+$/.test(field.value)){console.error("Неверное значение");field.setCustomValidity("Введите десятичное значение");event.preventDefault();event.stopPropagation();return false}else{console.log("Нет ошибки");field.setCustomValidity("")}}const forms=document.querySelectorAll(".needs-validation");Array.from(forms).forEach((form=>{form.addEventListener("submit",(event=>{if(!form.checkValidity()){event.preventDefault();event.stopPropagation()}const field=form.querySelector(".expectingDecimal");field.addEventListener("input",(function(event){checkDecimalValidity(event.currentTarget,event)}));checkDecimalValidity(field,event);form.classList.add("was-validated")}),false)}))})();function collectData(){return{erythrocytes:parseFloat($("#erythrocytes").val().replaceAll(",",".")),hemoglobin:parseFloat($("#hemoglobin").val()),pulse:parseFloat($("#pulse").val()),hematocrit:parseFloat($("#hematocrit").val()),age:parseFloat($("#age").val()),coffeeVomit:$("#coffeeVomit").is(":checked"),melena:$("#melena").is(":checked"),lossConsciousness:$("#lossConsciousness").is(":checked"),bloodArterialPressure:parseFloat($("#bloodArterialPressure").val()),additionalIllness:$("#additionalIllness").is(":checked"),bloodVomit:$("#bloodVomit").is(":checked"),hematohesia:$("#hematohesia").is(":checked"),collaptoidState:$("#collaptoidState").is(":checked"),gastrointestinalUcler:$("#gastrointestinalUcler").is(":checked"),paleSkin:$("#paleSkin").is(":checked"),hemoglobinFalls:this.hemoglobin<100,hiddenBleeding:$("#hiddenBleeding").is(":checked"),stickySweat:$("#stickySweat").is(":checked"),gender:$('input[name="gender"]:checked').attr("id"),anamnesisGastrointestinalUpperBleeding:$("#anamnesisGastrointestinalUpperBleeding").is(":checked"),anamnesisGastrointestinalUndefinedBleeding:$("#anamnesisGastrointestinalUndefinedBleeding").is(":checked"),v21:$("#sign21").is(":checked"),v22:$("#sign22").is(":checked"),v23:$("#sign23").is(":checked"),v24:$("#sign24").is(":checked"),v25:$("#sign25").is(":checked"),v26:$("#sign26").is(":checked"),v27:$("#sign27").is(":checked"),v28:$("#sign28").is(":checked"),v29:$("#sign29").is(":checked"),v30:$("#sign30").is(":checked"),v31:$("#sign31").is(":checked"),v32:$("#sign32").is(":checked"),v33:$("#sign33").is(":checked"),v34:$("#sign34").is(":checked"),v35:$("#sign35").is(":checked"),hasResearchData:function(){return this.v21||this.v22||this.v23||this.v24||this.v25||this.v26||this.v27||this.v28||this.v29||this.v30||this.v31||this.v32||this.v33||this.v34||this.v35}}}function collectFinalData(){return{r1:$("#r1").is(":checked"),r2:$("#r2").is(":checked"),r3:$("#r3").is(":checked"),r4:$("#r4").is(":checked"),hasData:function(){return this.r1||this.r2||this.r3||this.r4},hasChecked:function(){return this.hasData()}}}let linkPattern=`<br><a href="#" type="button" class="text-black" data-bs-toggle="modal" data-bs-target="#additionalResearch">Ввести данные эндоскопического исследования</a>`;let advicePattern=$(`<div class="alert alert-info d-inline-block me-1" role="alert" id="text">EMPTY</div>`);function adviceResearch(researchName,needDataEdit){advicePattern.clone().html("ЭГДС").append(needDataEdit?linkPattern:null).appendTo($("#adviceLine"))}function info(message){console.info(`%c ${message}`,"color:#4CAF50; font-weight: bolder")}function showQuestion(question){$("#question").html(question)}function result(localizationIndex){$("#questionBlock").toggleClass("d-inline d-none");console.log("RESULT:",conclusion);if(localizationIndex===0){$(".postConclusion").html($(`<div class="alert alert-info my-2" role="alert">Консервативная терапия/наблюдение</div>`)).parent().toggleClass("d-none d-block")}else{$(".postConclusion").html(conclusionBuilder(conclusion).setLocalization(localizationIndex).andResolveReason(collectData()).getTag().clone().append(`, источником которого послужили : <b>${reasonsList[conclusion.reason]}</b>`).toggleClass("alert-info alert-primary")).parent().toggleClass("d-none d-block")}$.moveBottom()}function getSequence(){return{context:this,step1:{run:function(){adviceResearch("ЭГДС",true);showQuestion("Источник найден?");info("STAGE 1")},yes:()=>result(1),no:()=>sequence.step2,research:true},step2:{run:function(){adviceResearch("Колоноскопия",true);showQuestion("Источник найден?");info("STAGE 2")},yes:()=>result(3),no:()=>sequence.step3,research:true},step3:{run:function(){showQuestion("Кровотечение продолжается?");info("STAGE 3")},yes:()=>sequence.step4,no:()=>sequence.step5,research:false},step4:{run:function(){adviceResearch("КТ-ангиография и/или Инструментально-ассистированная энтероскопия и/или Сцинтиграфия и/или Хирургическое вмешательство",true);showQuestion("Источник найден?");info("STAGE 4")},yes:()=>result(2),no:()=>sequence.step5,research:true},step5:{run:function(){adviceResearch("Rg с пассажем бария или КТЭ или МРЭ");showQuestion("Имеется стриктура?");info("STAGE 5")},yes:()=>sequence.step6,no:()=>sequence.step7,research:false},step6:{run:function(){adviceResearch("Инструментально-ассистированная энтероскопия и/или Хирургическое вмешательство",true);info("STAGE 6");result(2)},yes:()=>null,no:()=>null,research:true},step7:{run:function(){adviceResearch("ВКЭ",true);showQuestion("источник найден?");info("STAGE 7")},yes:()=>sequence.step8,no:()=>result(0),research:true},step8:{run:function(){modalReasonsList.show();info("STAGE 8")},yes:()=>result(0),no:()=>sequence.step6,research:false}}}